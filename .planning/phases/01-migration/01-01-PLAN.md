---
phase: 01-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mcps/knowledge-mcp/ (entire directory via git subtree)
autonomous: true

must_haves:
  truths:
    - "Code exists at mcps/knowledge-mcp/ with full git history"
    - "All existing tests pass in new location before any code changes"
    - "Baseline established for regression detection"
  artifacts:
    - path: "mcps/knowledge-mcp/src/knowledge_mcp/server.py"
      provides: "MCP server entry point"
      min_lines: 100
    - path: "mcps/knowledge-mcp/pyproject.toml"
      provides: "Project configuration"
      contains: "knowledge-mcp"
    - path: "mcps/knowledge-mcp/tests/"
      provides: "Test suite"
  key_links:
    - from: "mcps/knowledge-mcp/src/knowledge_mcp/"
      to: "mcps/knowledge-mcp/tests/"
      via: "pytest imports"
      pattern: "from knowledge_mcp"
---

<objective>
Migrate knowledge-mcp code from external repository to mcps/knowledge-mcp/ using git subtree to preserve full commit history, then establish a passing test baseline before any code modifications.

Purpose: NFR-3.1 (test BEFORE changes) and NFR-3.2 (preserve git history) are critical migration safety requirements. This plan ensures we have a working, tested baseline that can be rolled back if later changes introduce regressions.

Output: Working knowledge-mcp codebase at new location with verified test suite passing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-migration/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Git subtree migration with history preservation</name>
  <files>mcps/knowledge-mcp/ (entire directory)</files>
  <action>
Migrate the complete knowledge-mcp repository from ../knowledge-mcp/ to mcps/knowledge-mcp/ using git subtree.

Steps:
1. First, remove the existing incomplete mcps/knowledge-mcp/ directory:
   ```bash
   rm -rf mcps/knowledge-mcp
   git add -A mcps/knowledge-mcp
   git commit -m "chore: remove old incomplete knowledge-mcp before migration"
   ```

2. Add the external repository as a remote and fetch:
   ```bash
   git remote add knowledge-mcp-source ../knowledge-mcp
   git fetch knowledge-mcp-source
   ```

3. Use git subtree to add with full history (NOT --squash):
   ```bash
   git subtree add --prefix=mcps/knowledge-mcp knowledge-mcp-source main
   ```

4. Verify history is preserved:
   ```bash
   git log --oneline mcps/knowledge-mcp/ | head -20
   ```
   Should show multiple commits, not just one.

5. Clean up remote (required):
   ```bash
   git remote remove knowledge-mcp-source
   ```

IMPORTANT: Do NOT use `cp -r` or simple file copy. This loses git history and violates NFR-3.2.

If git subtree fails with "prefix already exists", ensure step 1 completed and the directory is fully removed from git tracking.
  </action>
  <verify>
- `ls mcps/knowledge-mcp/src/knowledge_mcp/server.py` exists
- `git log --oneline mcps/knowledge-mcp/ | wc -l` shows more than 1 commit
- `git log --oneline mcps/knowledge-mcp/ | head -5` shows meaningful commit messages from original repo
- `git remote | grep -v knowledge-mcp-source || echo "Remote cleaned up"` confirms remote removed
  </verify>
  <done>
- mcps/knowledge-mcp/ contains complete codebase
- Git history shows original commits (not just one merge commit)
- Directory structure matches source: src/, tests/, pyproject.toml
- Temporary remote knowledge-mcp-source has been removed
  </done>
</task>

<task type="auto">
  <name>Task 2: Establish passing test baseline</name>
  <files>mcps/knowledge-mcp/</files>
  <action>
Install dependencies and run the full test suite to establish a passing baseline BEFORE any code modifications.

Steps:
1. Navigate to the migrated directory and create virtual environment:
   ```bash
   cd mcps/knowledge-mcp
   python -m venv .venv
   source .venv/bin/activate  # or .venv/Scripts/activate on Windows
   ```

2. Install Poetry if not available, then install dependencies:
   ```bash
   pip install poetry
   poetry install --with dev,chromadb
   ```

3. Run the full test suite:
   ```bash
   poetry run pytest tests/ -v --tb=short
   ```
   Record the number of tests and pass rate.

4. Run linting to verify code quality baseline:
   ```bash
   poetry run ruff check src/
   ```

5. Run type checking:
   ```bash
   poetry run pyright src/
   ```

Record all results. If any tests fail, DO NOT proceed to code changes. The baseline must be 100% passing.

CRITICAL (Pitfall #1): If tests fail at this stage, it's a migration issue (path problems, missing files), NOT a code issue. Debug the migration, don't modify code.
  </action>
  <verify>
- `poetry run pytest tests/ -v` shows all tests passing
- `poetry run ruff check src/` exits with code 0
- `poetry run pyright src/` shows no errors
  </verify>
  <done>
- All 26 test files execute successfully
- Test coverage at 80%+ (as reported by pytest-cov)
- Linting passes with no errors
- Type checking passes with no errors
- Baseline documented for regression comparison
  </done>
</task>

</tasks>

<verification>
Phase 1 Plan 01 verification:
1. Git log shows preserved history: `git log --oneline mcps/knowledge-mcp/ | head -10`
2. Complete test suite passes: `cd mcps/knowledge-mcp && poetry run pytest tests/`
3. Code quality baseline established: ruff and pyright pass
4. Temporary remote cleaned up: `git remote | grep knowledge-mcp-source` returns nothing
</verification>

<success_criteria>
- [ ] mcps/knowledge-mcp/ exists with full source tree
- [ ] Git history preserved (multiple commits visible in log)
- [ ] All existing tests pass (100% pass rate)
- [ ] Linting passes (ruff check)
- [ ] Type checking passes (pyright)
- [ ] No code modifications made (pure migration)
- [ ] Temporary git remote removed
</success_criteria>

<output>
After completion, create `.planning/phases/01-migration/01-01-SUMMARY.md`
</output>
