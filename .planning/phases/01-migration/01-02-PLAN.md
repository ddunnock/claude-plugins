---
phase: 01-migration
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - mcps/knowledge-mcp/pyproject.toml
autonomous: true

must_haves:
  truths:
    - "Dependencies are updated to target versions"
    - "Existing functionality still works after updates"
    - "All tests still pass after dependency updates"
  artifacts:
    - path: "mcps/knowledge-mcp/pyproject.toml"
      provides: "Updated dependency specifications"
      contains: "mcp = \">=1.25"
    - path: "mcps/knowledge-mcp/poetry.lock"
      provides: "Locked dependency versions"
  key_links:
    - from: "mcps/knowledge-mcp/pyproject.toml"
      to: "poetry.lock"
      via: "poetry lock"
      pattern: "mcp.*1\\.25"
---

<objective>
Update dependencies to target versions specified in research: MCP SDK >=1.25.0,<2, qdrant-client >=1.16.2. These updates are safe because research confirmed existing code uses the new API (not deprecated methods).

Purpose: Ensure we're on stable, supported library versions before adding new features. NFR-1.2 (retry logic) and existing patterns depend on these libraries working correctly.

Output: Updated pyproject.toml and poetry.lock with verified test suite still passing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-migration/01-RESEARCH.md
@.planning/phases/01-migration/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update dependency versions in pyproject.toml</name>
  <files>mcps/knowledge-mcp/pyproject.toml</files>
  <action>
Update the dependency version specifications in pyproject.toml to match research recommendations.

Changes to make:
1. Update MCP SDK version constraint (pin to v1.x to avoid v2.0 breaking changes):
   ```toml
   # Before: mcp = ">=1.0.0"
   # After:
   mcp = ">=1.25.0,<2"
   ```

2. Update qdrant-client version constraint:
   ```toml
   # Before: qdrant-client = ">=1.7.0"
   # After:
   qdrant-client = ">=1.16.2"
   ```

3. Keep docling pinned (per research - do NOT change):
   ```toml
   # Keep as-is:
   docling = "==2.69.0"
   docling-core = {extras = ["chunking"], version = "==2.60.0"}
   ```

4. All other dependencies remain unchanged.

IMPORTANT:
- Do NOT change docling version (research confirmed it's correct choice)
- Do NOT upgrade to mcp >=2.0 (breaking transport changes in Q1 2026)
- The existing code uses `client.search(collection_name=...)` which is the NEW API, safe for qdrant-client 1.16.2
  </action>
  <verify>
- `grep "mcp = " mcps/knowledge-mcp/pyproject.toml` shows `>=1.25.0,<2`
- `grep "qdrant-client" mcps/knowledge-mcp/pyproject.toml` shows `>=1.16.2`
- `grep "docling = " mcps/knowledge-mcp/pyproject.toml` shows `==2.69.0` (unchanged)
  </verify>
  <done>
- pyproject.toml has updated version constraints
- MCP SDK pinned to v1.x series
- qdrant-client updated to >=1.16.2
- Docling version unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Lock dependencies and verify tests pass</name>
  <files>mcps/knowledge-mcp/poetry.lock</files>
  <action>
Update the lock file with new dependency versions and run the full test suite to verify nothing broke.

Steps:
1. Update poetry.lock with new versions:
   ```bash
   cd mcps/knowledge-mcp
   poetry lock
   ```

2. Install the updated dependencies:
   ```bash
   poetry install --with dev,chromadb
   ```

3. Run the full test suite:
   ```bash
   poetry run pytest tests/ -v --tb=short
   ```
   ALL tests must pass. If any test fails, it indicates a breaking change - investigate before proceeding.

4. Run linting to ensure no new issues:
   ```bash
   poetry run ruff check src/
   ```

5. Run type checking:
   ```bash
   poetry run pyright src/
   ```

6. Verify actual installed versions:
   ```bash
   poetry show mcp
   poetry show qdrant-client
   ```
   Should show versions >= 1.25.0 and >= 1.16.2 respectively.

CRITICAL (Pitfall #5): If MCP tests fail, check for transport-related errors. If so, ensure mcp version is < 2.0.
CRITICAL (Pitfall #2): If qdrant tests fail with "no attribute 'search'", the code might use deprecated API - but research confirmed it doesn't.
  </action>
  <verify>
- `poetry run pytest tests/ -v` shows all tests passing
- `poetry show mcp` shows version >= 1.25.0 and < 2.0
- `poetry show qdrant-client` shows version >= 1.16.2
- `poetry run ruff check src/` exits with code 0
  </verify>
  <done>
- poetry.lock updated with new dependency versions
- All tests pass after dependency update
- MCP SDK version is 1.25.x (not 2.x)
- qdrant-client version is 1.16.2+
- Code quality unchanged (ruff, pyright pass)
  </done>
</task>

</tasks>

<verification>
Phase 1 Plan 02 verification:
1. Dependencies locked to target versions
2. Full test suite passes with new dependencies
3. No deprecated API warnings in test output
</verification>

<success_criteria>
- [ ] pyproject.toml updated with new version constraints
- [ ] poetry.lock regenerated with actual new versions
- [ ] All tests pass after dependency update
- [ ] MCP SDK version is 1.25.x (verified via poetry show)
- [ ] qdrant-client version is 1.16.2+ (verified via poetry show)
- [ ] No regressions from baseline
</success_criteria>

<output>
After completion, create `.planning/phases/01-migration/01-02-SUMMARY.md`
</output>
