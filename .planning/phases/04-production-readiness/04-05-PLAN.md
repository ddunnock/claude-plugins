---
phase: 04-production-readiness
plan: 05
type: execute
wave: 4
depends_on: ["04-04"]
files_modified:
  - mcps/knowledge-mcp/manifest.json
  - mcps/knowledge-mcp/scripts/package_mcpb.sh
  - mcps/knowledge-mcp/README.md
autonomous: false

must_haves:
  truths:
    - "manifest.json follows MCPB specification"
    - "Packaging script validates and creates .mcpb bundle"
    - "README includes installation and usage instructions"
    - "Plugin works in Claude Desktop (verified by human)"
  artifacts:
    - path: "mcps/knowledge-mcp/manifest.json"
      provides: "MCPB bundle manifest"
      contains: "schema_version"
      min_lines: 30
    - path: "mcps/knowledge-mcp/scripts/package_mcpb.sh"
      provides: "Packaging script"
      min_lines: 15
    - path: "mcps/knowledge-mcp/README.md"
      provides: "Installation documentation"
      contains: "Installation"
  key_links:
    - from: "manifest.json"
      to: "pyproject.toml"
      via: "dependency alignment"
      pattern: "mcp.*openai.*qdrant"
---

<objective>
Create MCPB packaging for Claude Desktop distribution and finalize documentation.

Purpose: Package knowledge-mcp for marketplace distribution as Claude Desktop plugin. Users should be able to install with one click.
Output: manifest.json, packaging script, updated README, human-verified installation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@mcps/knowledge-mcp/pyproject.toml
@mcps/knowledge-mcp/README.md
@.planning/phases/04-production-readiness/04-RESEARCH.md
@.planning/phases/04-production-readiness/04-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MCPB manifest and packaging script</name>
  <files>
mcps/knowledge-mcp/manifest.json
mcps/knowledge-mcp/scripts/package_mcpb.sh
  </files>
  <action>
Create `manifest.json` following MCPB specification:

```json
{
  "schema_version": "v1",
  "name": "knowledge-mcp",
  "version": "0.1.0",
  "description": "Semantic search over engineering standards (IEEE, INCOSE, ISO). Provides RAG capabilities for systems engineering knowledge.",
  "author": {
    "name": "David Dunnock",
    "email": "dunnoda@gmail.com"
  },
  "homepage": "https://github.com/dunnock/claude-plugins/tree/main/mcps/knowledge-mcp",
  "license": "MIT",
  "server": {
    "type": "python",
    "module": "knowledge_mcp",
    "python_version": ">=3.11",
    "dependencies": [
      "mcp>=1.25.0,<2",
      "openai>=1.0.0",
      "qdrant-client>=1.16.2",
      "tiktoken>=0.5.0",
      "python-dotenv>=1.0.0",
      "tenacity>=8.0.0",
      "pydantic>=2.0.0",
      "rich>=13.0.0",
      "diskcache>=5.6.0"
    ]
  },
  "configuration": {
    "required": [
      {
        "name": "OPENAI_API_KEY",
        "description": "OpenAI API key for generating embeddings"
      }
    ],
    "optional": [
      {
        "name": "QDRANT_URL",
        "description": "Qdrant Cloud cluster URL (if using Qdrant)"
      },
      {
        "name": "QDRANT_API_KEY",
        "description": "Qdrant Cloud API key"
      },
      {
        "name": "EMBEDDING_MODEL",
        "description": "OpenAI embedding model (default: text-embedding-3-small)"
      },
      {
        "name": "CHROMADB_PATH",
        "description": "Path for local ChromaDB storage"
      }
    ]
  },
  "tools": [
    {
      "name": "knowledge_search",
      "description": "Search engineering standards knowledge base for relevant content. Returns chunks with source citations."
    },
    {
      "name": "knowledge_stats",
      "description": "Get statistics about the knowledge base collections and document counts."
    },
    {
      "name": "knowledge_ingest",
      "description": "Ingest a new document into the knowledge base."
    }
  ],
  "keywords": [
    "systems-engineering",
    "standards",
    "ieee",
    "incose",
    "rag",
    "semantic-search"
  ]
}
```

Create `scripts/package_mcpb.sh`:

```bash
#!/bin/bash
# Package knowledge-mcp as MCPB bundle for Claude Desktop
#
# Prerequisites:
#   npm install -g @anthropic-ai/mcpb
#
# Usage:
#   ./scripts/package_mcpb.sh

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_DIR"

echo "=== Packaging knowledge-mcp as MCPB bundle ==="
echo ""

# Check mcpb installed
if ! command -v mcpb &> /dev/null; then
    echo "ERROR: mcpb not found. Install with:"
    echo "  npm install -g @anthropic-ai/mcpb"
    exit 1
fi

# Check manifest exists
if [ ! -f manifest.json ]; then
    echo "ERROR: manifest.json not found"
    exit 1
fi

# Validate manifest
echo "Validating manifest.json..."
mcpb validate manifest.json
echo ""

# Run tests before packaging
echo "Running tests..."
poetry run pytest tests/ -v --tb=short
echo ""

# Create bundle
echo "Creating .mcpb bundle..."
mcpb pack

# Find created bundle
BUNDLE=$(ls -t *.mcpb 2>/dev/null | head -1)

if [ -n "$BUNDLE" ]; then
    echo ""
    echo "=== SUCCESS ==="
    echo "Bundle created: $BUNDLE"
    echo ""
    echo "Installation options:"
    echo "  1. Double-click $BUNDLE"
    echo "  2. Drag to Claude Desktop"
    echo "  3. Run: mcpb install $BUNDLE"
    echo ""
    echo "Required configuration:"
    echo "  OPENAI_API_KEY - OpenAI API key for embeddings"
    echo ""
    echo "Optional configuration:"
    echo "  QDRANT_URL, QDRANT_API_KEY - For Qdrant Cloud storage"
    echo "  CHROMADB_PATH - For local ChromaDB storage"
else
    echo "ERROR: Bundle not created"
    exit 1
fi
```

Make script executable:
```bash
chmod +x mcps/knowledge-mcp/scripts/package_mcpb.sh
```
  </action>
  <verify>manifest.json exists and `cat mcps/knowledge-mcp/manifest.json | python -m json.tool` validates</verify>
  <done>MCPB manifest and packaging script created</done>
</task>

<task type="auto">
  <name>Task 2: Update README with installation instructions</name>
  <files>mcps/knowledge-mcp/README.md</files>
  <action>
Update README.md to include comprehensive installation and usage documentation.

Add the following sections (preserve any existing content that's still relevant):

```markdown
# Knowledge MCP

Semantic search over engineering standards (IEEE, INCOSE, ISO, NASA) for systems engineering RAG workflows.

## Features

- **Semantic Search**: Find relevant standards content using natural language queries
- **Source Citations**: Results include standard name, clause number, and page references
- **Hybrid Storage**: Qdrant Cloud (primary) with ChromaDB fallback for offline use
- **Evaluation Framework**: Golden test set with RAG metrics for quality monitoring
- **Cost Tracking**: Token usage monitoring with daily aggregation

## Installation

### Claude Desktop (Recommended)

1. Download the latest `.mcpb` bundle from releases
2. Double-click to install, or drag to Claude Desktop
3. Configure environment variables when prompted:
   - `OPENAI_API_KEY` (required): Your OpenAI API key

### Manual Installation

```bash
# Clone the repository
git clone https://github.com/dunnock/claude-plugins.git
cd claude-plugins/mcps/knowledge-mcp

# Install dependencies
poetry install --with dev,chromadb

# Configure environment
cp .env.example .env
# Edit .env with your API keys

# Run the server
poetry run python -m knowledge_mcp
```

## Configuration

### Required

| Variable | Description |
|----------|-------------|
| `OPENAI_API_KEY` | OpenAI API key for embedding generation |

### Optional

| Variable | Default | Description |
|----------|---------|-------------|
| `QDRANT_URL` | - | Qdrant Cloud cluster URL |
| `QDRANT_API_KEY` | - | Qdrant Cloud API key |
| `EMBEDDING_MODEL` | `text-embedding-3-small` | OpenAI embedding model |
| `CHROMADB_PATH` | `./data/chromadb` | Local ChromaDB storage path |
| `COLLECTION_NAME` | `se_knowledge_base` | Vector collection name |

## Usage

### MCP Tools

Once installed, the following tools are available in Claude:

**knowledge_search**
```
Search for: "system verification requirements"
```
Returns relevant chunks with source citations (e.g., "IEEE 15288 Clause 6.4.7").

**knowledge_stats**
```
Show knowledge base statistics
```
Returns collection counts and storage information.

### CLI Commands

```bash
# Token usage summary
poetry run python -m knowledge_mcp.cli.token_summary --days 7

# Run golden tests
poetry run pytest tests/evaluation/ -v
```

## Development

### Running Tests

```bash
# All tests
poetry run pytest tests/ -v

# With coverage
poetry run pytest tests/ --cov=src --cov-report=term-missing

# Evaluation tests only
poetry run pytest tests/evaluation/ -v
```

### Quality Checks

```bash
# Type checking
poetry run pyright

# Linting
poetry run ruff check src tests
poetry run ruff format src tests
```

### Building Package

```bash
# Create MCPB bundle
./scripts/package_mcpb.sh
```

## Architecture

```
knowledge-mcp/
├── src/knowledge_mcp/
│   ├── server.py          # MCP server entry point
│   ├── search/            # Semantic search implementation
│   ├── embed/             # Embedding generation + cache
│   ├── store/             # Vector storage (Qdrant, ChromaDB)
│   ├── evaluation/        # Golden tests + RAG metrics
│   └── monitoring/        # Token tracking + logging
├── data/
│   ├── golden_queries.yml # Evaluation test set
│   └── embedding_cache/   # Cached embeddings
└── tests/
```

## License

MIT License - see LICENSE file.
```

Ensure the README flows naturally and integrates with any existing content.
  </action>
  <verify>README.md exists and contains "Installation" and "Configuration" sections</verify>
  <done>README updated with comprehensive installation and usage docs</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 4 production readiness package:
- Embedding cache with content hashing
- Token tracking with cost monitoring
- Golden test set (34 queries)
- RAG evaluation framework
- MCPB packaging for Claude Desktop
- Updated documentation
  </what-built>
  <how-to-verify>
1. **Run all tests:**
   ```bash
   cd mcps/knowledge-mcp
   poetry run pytest tests/ -v --tb=short
   ```
   Expected: All tests pass

2. **Verify embedding cache works:**
   ```bash
   poetry run python -c "
   from pathlib import Path
   import tempfile
   from knowledge_mcp.embed import EmbeddingCache

   with tempfile.TemporaryDirectory() as d:
       cache = EmbeddingCache(Path(d), 'test-model')
       cache.set('hello', [0.1, 0.2])
       print(f'Cache get: {cache.get(\"hello\")}')
       print(f'Cache stats: {cache.stats()}')
   "
   ```
   Expected: Shows cached embedding and stats

3. **Verify token tracker works:**
   ```bash
   poetry run python -c "
   from pathlib import Path
   import tempfile
   from knowledge_mcp.monitoring import TokenTracker

   with tempfile.NamedTemporaryFile(suffix='.json') as f:
       tracker = TokenTracker(Path(f.name))
       tokens = tracker.count_tokens('Hello world')
       print(f'Token count: {tokens}')
       tracker.track_embedding('Test text')
       print(f'Daily summary: {tracker.get_daily_summary()}')
   "
   ```
   Expected: Shows token count and daily summary

4. **Verify golden test set loads:**
   ```bash
   poetry run python -c "
   from pathlib import Path
   from knowledge_mcp.evaluation import GoldenTestSet

   g = GoldenTestSet(Path('data/golden_queries.yml'))
   queries = g.load_queries()
   print(f'Loaded {len(queries)} golden queries')
   print(f'Categories: {set(q.category for q in queries)}')
   "
   ```
   Expected: 34+ queries across 6 categories

5. **Verify manifest.json is valid:**
   ```bash
   cat manifest.json | python -m json.tool > /dev/null && echo "JSON valid"
   ```
   Expected: "JSON valid"

6. **Optional - Test MCPB packaging (requires mcpb):**
   ```bash
   # Install mcpb if not present
   npm install -g @anthropic-ai/mcpb

   # Validate manifest
   mcpb validate manifest.json
   ```
   Expected: Validation passes
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
Human verification required. See checkpoint task for verification steps.
</verification>

<success_criteria>
- [ ] manifest.json follows MCPB specification
- [ ] scripts/package_mcpb.sh executable and documented
- [ ] README.md has installation and usage sections
- [ ] Human verifies all Phase 4 components work together
</success_criteria>

<output>
After completion, create `.planning/phases/04-production-readiness/04-05-SUMMARY.md`
</output>
