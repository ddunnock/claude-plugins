---
phase: 01-core-acquisition
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/knowledge_mcp/db/migrations/env.py
  - src/knowledge_mcp/db/migrations/alembic.ini
  - src/knowledge_mcp/db/migrations/versions/001_initial_schema.py
autonomous: true

must_haves:
  truths:
    - "Alembic migrations create Source and AcquisitionRequest tables"
    - "Running 'alembic upgrade head' creates all tables successfully"
    - "Running 'alembic downgrade base' removes all tables"
    - "Migration tracks version history correctly"
  artifacts:
    - path: "src/knowledge_mcp/db/migrations/env.py"
      provides: "Async migration environment"
      contains: "async_engine_from_config"
    - path: "src/knowledge_mcp/db/migrations/alembic.ini"
      provides: "Alembic configuration"
    - path: "src/knowledge_mcp/db/migrations/versions/001_initial_schema.py"
      provides: "Initial schema migration"
      contains: "create_table"
  key_links:
    - from: "src/knowledge_mcp/db/migrations/env.py"
      to: "src/knowledge_mcp/db/models.py"
      via: "imports Base for metadata"
      pattern: "from.*models import Base"
---

<objective>
Set up Alembic async migrations and create initial schema migration for Source and AcquisitionRequest tables.

Purpose: Enable database schema management with version-controlled migrations (Alembic async template from research).
Output: Working migration system with initial v2 schema that can be applied to PostgreSQL.
</objective>

<execution_context>
@/Users/dunnock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dunnock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-acquisition/01-RESEARCH.md

# Depends on Plan 01 outputs
@src/knowledge_mcp/db/models.py
@src/knowledge_mcp/utils/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Alembic with async template</name>
  <files>src/knowledge_mcp/db/migrations/</files>
  <action>
    1. Create migrations directory structure:
       mkdir -p src/knowledge_mcp/db/migrations/versions

    2. Initialize Alembic with async template:
       cd src/knowledge_mcp/db
       alembic init -t async migrations

       This creates:
       - migrations/env.py (async version)
       - migrations/script.py.mako (template)
       - migrations/alembic.ini

    3. Move alembic.ini to migrations/ directory if not already there.

    Note: The `-t async` flag uses the official async template which handles
    run_sync() wrapper correctly (Pitfall #2 from research).

    AVOID: Using default sync template.
    WHY: Async template handles SQLAlchemy 2.0 async engine properly.
  </action>
  <verify>
    ls src/knowledge_mcp/db/migrations/
    # Should show: env.py, script.py.mako, alembic.ini, versions/
  </verify>
  <done>
    Alembic initialized with async template.
    Directory structure created at src/knowledge_mcp/db/migrations/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Alembic for Knowledge MCP</name>
  <files>src/knowledge_mcp/db/migrations/alembic.ini, src/knowledge_mcp/db/migrations/env.py</files>
  <action>
    1. Update alembic.ini with these key settings:
       - script_location = src/knowledge_mcp/db/migrations
       - prepend_sys_path = .
       - sqlalchemy.url left empty (set dynamically in env.py)

    2. Update env.py to:
       - Add project root to sys.path for imports
       - Import Base from knowledge_mcp.db.models
       - Import load_config from knowledge_mcp.utils.config
       - Override sqlalchemy.url from app_config.database_url
       - Set target_metadata = Base.metadata
       - Use pool.NullPool for migrations (no connection pooling)
       - Implement do_run_migrations() as sync function
       - Implement run_async_migrations() using async_engine_from_config

    Key patterns from research:
    - do_run_migrations(connection) is synchronous
    - run_async_migrations() calls connection.run_sync(do_run_migrations)
    - Use asyncio.run(run_async_migrations()) in run_migrations_online()

    AVOID: Using connection pooling in migrations.
    WHY: Migrations are one-off; NullPool prevents connection leaks (from research).
  </action>
  <verify>
    python -c "
    import sys
    sys.path.insert(0, 'src')
    from knowledge_mcp.db.models import Base
    print(f'Tables: {list(Base.metadata.tables.keys())}')
    "
  </verify>
  <done>
    alembic.ini configured with correct script_location.
    env.py loads database_url from KnowledgeConfig.
    env.py imports Base.metadata for autogenerate.
    Async migration pattern implemented correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create initial schema migration</name>
  <files>src/knowledge_mcp/db/migrations/versions/001_initial_schema.py</files>
  <action>
    Create the initial migration manually (don't use autogenerate for first migration).

    The migration should:
    1. Create enums first:
       - sourcetype: 'document', 'web', 'standard'
       - sourcestatus: 'pending', 'ingesting', 'complete', 'failed'
       - authoritytier: 'tier1', 'tier2', 'tier3'
       - acquisitionrequeststatus: 'pending', 'in_progress', 'completed', 'failed', 'cancelled'

    2. Create acquisition_requests table:
       - id (Integer, primary key)
       - url (String 2048, not null)
       - reason (Text, nullable)
       - priority (Integer, default 0)
       - status (enum, default 'pending')
       - created_at, updated_at (DateTime with server_default now())
       - completed_at (DateTime, nullable)
       - source_id (Integer, nullable - links to created Source)
       - error_message (Text, nullable)
       - Indexes on status and priority

    3. Create sources table:
       - id (Integer, primary key)
       - url (String 2048, not null, unique)
       - title (String 500, nullable)
       - source_type (enum, not null)
       - status (enum, default 'pending')
       - authority_tier (enum, default 'tier3')
       - created_at, updated_at (DateTime with server_default now())
       - last_ingested_at (DateTime, nullable)
       - chunk_count (Integer, default 0)
       - error_message (Text, nullable)
       - acquisition_request_id (Integer, FK to acquisition_requests.id, nullable)
       - Indexes on source_type, status, authority_tier

    4. Implement downgrade() to:
       - Drop sources table
       - Drop acquisition_requests table
       - Drop all enums (in reverse order)

    AVOID: Using async functions in upgrade/downgrade.
    WHY: Alembic migrations use run_sync() - they must be synchronous (Pitfall #2).
  </action>
  <verify>
    # Verify migration file is valid Python
    python -c "
    import sys
    sys.path.insert(0, 'src/knowledge_mcp/db/migrations/versions')
    "

    # Check alembic can see the migration
    cd src/knowledge_mcp/db && alembic history
  </verify>
  <done>
    Initial migration creates sources and acquisition_requests tables.
    All enums created with proper PostgreSQL enum types.
    Indexes on commonly filtered columns (status, source_type, authority_tier).
    Foreign key from sources to acquisition_requests.
    downgrade() properly drops tables and enums.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Alembic structure exists:**
   ls -la src/knowledge_mcp/db/migrations/
   # Should show: env.py, script.py.mako, alembic.ini, versions/

2. **Migration file valid:**
   python -c "
   import ast
   ast.parse(open('src/knowledge_mcp/db/migrations/versions/001_initial_schema.py').read())
   print('Migration syntax valid')
   "

3. **Alembic sees migration:**
   cd src/knowledge_mcp/db && alembic history
   # Should show: 001 -> head (Initial schema)

4. **env.py imports work:**
   python -c "
   import sys
   sys.path.insert(0, 'src')
   from knowledge_mcp.db.models import Base
   from knowledge_mcp.utils.config import load_config
   print('Imports work')
   "

Note: Actual migration testing requires PostgreSQL database connection.
Document that `alembic upgrade head` should be run when database is available.
</verification>

<success_criteria>
- [ ] Alembic initialized with async template in src/knowledge_mcp/db/migrations/
- [ ] alembic.ini configured with correct script_location
- [ ] env.py loads database_url from KnowledgeConfig
- [ ] env.py imports Base.metadata for autogenerate support
- [ ] env.py uses pool.NullPool for migrations
- [ ] Initial migration creates sources and acquisition_requests tables
- [ ] Migration creates all required enums (sourcetype, sourcestatus, authoritytier, acquisitionrequeststatus)
- [ ] Migration adds indexes on status, source_type, authority_tier columns
- [ ] downgrade() properly reverses all changes
- [ ] alembic history shows the migration
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-acquisition/01-03-SUMMARY.md`
</output>
