---
phase: 04-test-coverage
plan: 04
type: execute
wave: 2
depends_on: [04-01, 04-02, 04-03]
files_modified:
  - pyproject.toml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Overall coverage reaches 80% line coverage"
    - "Overall coverage reaches 75% branch coverage"
    - "pytest --cov passes without failures"
  artifacts:
    - path: "pyproject.toml"
      provides: "Coverage configuration"
      contains: "cov-fail-under"
  key_links:
    - from: "pyproject.toml"
      to: "pytest execution"
      via: "tool.pytest.ini_options"
      pattern: "cov-fail-under"
---

<objective>
Verify overall coverage meets 80% threshold and fix any remaining gaps.

Purpose: After Plans 01-03, coverage should be near 80%. This plan verifies the threshold is met and addresses any remaining small gaps.

Output: Verified 80% coverage, any necessary gap-filling tests added.
</objective>

<execution_context>
@/Users/dunnock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dunnock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Phase context:
@.planning/phases/04-test-coverage/04-01-SUMMARY.md
@.planning/phases/04-test-coverage/04-02-SUMMARY.md
@.planning/phases/04-test-coverage/04-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run full coverage report and identify gaps</name>
  <files>read-only: src/knowledge_mcp/**/*.py</files>
  <action>
Run full test suite with coverage and analyze results (read-only analysis task):

1. Run pytest with full coverage:
```bash
poetry run pytest --cov=src/knowledge_mcp --cov-report=term-missing --cov-report=html
```

2. Analyze the coverage report for:
   - Overall line coverage (target: >= 80%)
   - Overall branch coverage (target: >= 75%)
   - Any modules still below 80% that are worth testing

3. Note any remaining gaps by module:
   - evaluation/metrics.py (14%) - LOW priority, evaluation code
   - evaluation/reporter.py (9%) - LOW priority, evaluation code
   - cli/token_summary.py (0%) - LOW priority, CLI utility

The evaluation modules and CLI utilities are low priority because:
- They're not on the critical path (search -> store -> MCP)
- They're optional tooling, not core functionality
- The 80% is an aggregate target, not per-module

4. If overall coverage is >= 80%, proceed to Task 2.
   If < 80%, identify highest-impact gaps and add targeted tests to the files listed below.
  </action>
  <verify>
```bash
poetry run pytest --cov=src/knowledge_mcp --cov-report=term-missing 2>&1 | tail -20
```
Check the TOTAL line shows >= 80% coverage.
  </verify>
  <done>Full coverage report generated showing >= 80% line coverage.</done>
</task>

<task type="auto">
  <name>Task 2: Verify and document final coverage</name>
  <files>pyproject.toml</files>
  <action>
Ensure pyproject.toml has correct coverage thresholds:

1. Verify pytest coverage settings in pyproject.toml:
```toml
[tool.pytest.ini_options]
addopts = "--cov=src/knowledge_mcp --cov-fail-under=80"
```

Or in [tool.coverage.report]:
```toml
[tool.coverage.report]
fail_under = 80
exclude_lines = [
    "pragma: no cover",
    "if TYPE_CHECKING:",
    "raise NotImplementedError",
]
```

2. Run final verification:
```bash
poetry run pytest --cov=src/knowledge_mcp --cov-fail-under=80
```

3. Document final coverage state for SUMMARY.md:
   - Line coverage: XX%
   - Branch coverage: XX%
   - Modules with low coverage (and why acceptable)

4. If any tests fail, fix them before completing.
  </action>
  <verify>
```bash
poetry run pytest --cov=src/knowledge_mcp --cov-fail-under=80 --cov-branch
```
Test run should complete successfully without "FAIL Required test coverage" message.
  </verify>
  <done>pytest --cov passes with >= 80% line coverage threshold.</done>
</task>

</tasks>

<verification>
```bash
# Final comprehensive check
poetry run pytest --cov=src/knowledge_mcp --cov-report=term-missing --cov-fail-under=80

# Verify pyright still passes
poetry run pyright

# Verify ruff still passes
poetry run ruff check src tests
```

All checks should pass.
</verification>

<success_criteria>
- pytest --cov reports >= 80% line coverage
- pytest --cov reports >= 75% branch coverage (if branch coverage checked)
- pytest --cov-fail-under=80 passes without failure
- Zero pyright errors
- Zero ruff errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-04-SUMMARY.md`
</output>
